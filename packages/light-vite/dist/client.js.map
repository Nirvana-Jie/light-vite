{"version":3,"sources":["../src/client/client.ts"],"sourcesContent":["console.log(\"[light-vite] connecting...\");\n\nconst socket = new WebSocket(\"ws://localhost:__HMR_PORT__\", \"light-vite-hmr\");\n\nsocket.addEventListener(\"message\", async ({ data }) => {\n  handleMessage(JSON.parse(data)).catch(console.error);\n});\n\ninterface Update {\n  type: \"js-update\" | \"css-update\";\n  path: string;\n  acceptedPath: string;\n  timestamp: number;\n}\n\nasync function handleMessage(payload: any) {\n  switch (payload.type) {\n    case \"connected\":\n      console.log(\"[light-vite] connected.\");\n      setInterval(() => socket.send(\"ping\"), 1000);\n      break;\n\n    case \"update\":\n      payload.updates.forEach((update: Update) => {\n        if (update.type === \"js-update\") {\n          fetchUpdate(update);\n        }\n      });\n      break;\n  }\n}\n\ninterface HotModule {\n  id: string;\n  callbacks: HotCallback[];\n}\n\ninterface HotCallback {\n  deps: string[];\n  fn: (modules: object[]) => void;\n}\n\nconst hotModulesMap = new Map<string, HotModule>();\nconst pruneMap = new Map<string, (data: any) => void | Promise<void>>();\n\nexport const createHotContext = (ownerPath: string) => {\n  const mod = hotModulesMap.get(ownerPath);\n  if (mod) {\n    mod.callbacks = [];\n  }\n\n  function acceptDeps(deps: string[], callback: any) {\n    const mod: HotModule = hotModulesMap.get(ownerPath) || {\n      id: ownerPath,\n      callbacks: [],\n    };\n    mod.callbacks.push({\n      deps,\n      fn: callback,\n    });\n    hotModulesMap.set(ownerPath, mod);\n  }\n\n  return {\n    accept(deps: any) {\n      if (typeof deps === \"function\" || !deps) {\n        acceptDeps([ownerPath], ([mod]: any) => deps && deps(mod));\n      }\n    },\n    prune(cb: (data: any) => void) {\n      pruneMap.set(ownerPath, cb);\n    },\n  };\n};\n\nasync function fetchUpdate({ path, timestamp }: Update) {\n  const mod = hotModulesMap.get(path);\n  if (!mod) return;\n\n  const moduleMap = new Map();\n  const modulesToUpdate = new Set<string>();\n\n  modulesToUpdate.add(path);\n\n  await Promise.all(\n    Array.from(modulesToUpdate).map(async (dep) => {\n      const [path, query] = dep.split(\"?\");\n      try {\n        const newMod = await import(\n          path + `?t=${timestamp}${query ? `&${query}` : \"\"}`\n        );\n        moduleMap.set(dep, newMod);\n      } catch (e) {}\n    })\n  );\n\n  return () => {\n    for (const { deps, fn } of mod.callbacks) {\n      fn(deps.map((dep: any) => moduleMap.get(dep)));\n    }\n    console.log(`[light-vite] hot updated: ${path}`);\n  };\n}\n\nconst sheetsMap = new Map();\n\nexport function updateStyle(id: string, content: string) {\n  let style = sheetsMap.get(id);\n  if (!style) {\n    style = document.createElement(\"style\");\n    style.setAttribute(\"type\", \"text/css\");\n    style.innerHTML = content;\n    document.head.appendChild(style);\n  } else {\n    style.innerHTML = content;\n  }\n  sheetsMap.set(id, style);\n}\n\nexport function removeStyle(id: string): void {\n  const style = sheetsMap.get(id);\n  if (style) {\n    document.head.removeChild(style);\n  }\n  sheetsMap.delete(id);\n}\n"],"mappings":"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","names":["mod","path"]}